name: Docker Image Factory

on:
  push:
    branches:
      - main
    paths:
      - "images/**"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase owner
        run: |
          echo "OWNER=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize README
        run: |
          printf "# ðŸ³ Docker Image Factory\n\n" > README.md
          printf "Central repository that builds and publishes Docker images for all projects.\n\n" >> README.md
          printf "## ðŸ“¦ Published Images\n\n" >> README.md
          printf "| Image | Pull Command | Size | Build Time | Last Build |\n" >> README.md
          printf "|------|--------------|------|-----------|-----------|\n" >> README.md

      - name: Build and publish images
        shell: bash
        run: |
          set -euo pipefail

          for dir in images/*; do
            if [ ! -f "$dir/Dockerfile" ]; then
              continue
            fi

            IMAGE_NAME=$(basename "$dir")
            IMAGE="$REGISTRY/$OWNER/$IMAGE_NAME"

            echo "ðŸ”¨ Building $IMAGE"

            START=$(date +%s)

            docker build \
              -t "$IMAGE:latest" \
              -t "$IMAGE:${{ github.sha }}" \
              "$dir"

            docker push "$IMAGE:latest"
            docker push "$IMAGE:${{ github.sha }}"

            END=$(date +%s)
            BUILD_TIME=$((END - START))

            SIZE_BYTES=$(docker image inspect "$IMAGE:latest" --format='{{.Size}}')
            SIZE_HUMAN=$(numfmt --to=iec --suffix=B "$SIZE_BYTES")

            DATE=$(date -u +"%Y-%m-%d %H:%M UTC")

            printf "| %s | docker pull %s:latest | %s | %ss | %s |\n" \
              "$IMAGE_NAME" "$IMAGE" "$SIZE_HUMAN" "$BUILD_TIME" "$DATE" >> README.md
          done

      - name: Commit README
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "chore: update docker image registry [auto]" || true
          git push
